stages:
  - test
  - deploy

variables:
  # flyctl version — pin for reproducibility
  FLYCTL_VERSION: "0.3.130"

# ─── Test ────────────────────────────────────────────────────────
typecheck:
  stage: test
  image: oven/bun:1
  script:
    - cd web && bun install --frozen-lockfile
    - bun run typecheck
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

test:
  stage: test
  image: oven/bun:1
  script:
    - cd web && bun install --frozen-lockfile
    - bun run test
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# ─── Deploy to Fly.io ───────────────────────────────────────────
# Fly.io builds the Docker image on their remote builder and deploys
# directly — no external registry needed. The container is ephemeral.
#
# Required CI/CD variables (Settings > CI/CD > Variables):
#   FLY_API_TOKEN  — from `fly tokens deploy` (app-scoped, least privilege)
#
# Secrets set directly on Fly.io (NOT in CI/CD):
#   ANTHROPIC_API_KEY  — `fly secrets set ANTHROPIC_API_KEY=...`
#   AUTH_USERNAME       — `fly secrets set AUTH_USERNAME=...`
#   AUTH_PASSWORD       — `fly secrets set AUTH_PASSWORD=...`
deploy:
  stage: deploy
  image: alpine:latest
  script:
    - apk add --no-cache curl
    - curl -L "https://fly.io/install.sh" | sh
    - export PATH="$HOME/.fly/bin:$PATH"
    - flyctl deploy --remote-only
  environment:
    name: production
    url: https://claude-control.fly.dev
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  variables:
    FLY_API_TOKEN: $FLY_API_TOKEN
